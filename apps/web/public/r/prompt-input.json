{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "prompt-input",
  "type": "registry:component",
  "title": "AgentStart Prompt Input",
  "description": "Reusable prompt input for both home page (create thread) and chat page (send message). Supports file attachments via drag-and-drop, loading states, and blob storage integration.",
  "dependencies": [
    "@phosphor-icons/react",
    "@tanstack/react-query",
    "agentstart",
    "ai",
    "nanoid",
    "react"
  ],
  "registryDependencies": [
    "@coss/button",
    "@coss/menu",
    "@coss/preview-card",
    "@coss/textarea",
    "@coss/alert",
    "@coss/spinner"
  ],
  "files": [
    {
      "path": "src/registry/agentstart/prompt-input.tsx",
      "content": "/* agent-frontmatter:start\nAGENT: AgentStart prompt input component\nPURPOSE: Integrated prompt input with file attachments, queue, and usage display\nUSAGE: <PromptInput />\nEXPORTS: PromptInput, PromptInputProps\nFEATURES:\n  - Dual mode: create new thread or send message to existing thread\n  - Gets threadId from useAgentStartContext\n  - File attachments via drag-and-drop, paste, or picker\n  - Message queue management\n  - Usage summary display\n  - Integrated state management\nSEARCHABLE: prompt input, message input, thread creation, chat input, attachments\nagent-frontmatter:end */\n\n\"use client\";\n\nimport {\n  ArrowDownIcon,\n  ArrowUpIcon,\n  BugIcon,\n  FileIcon,\n  ImageIcon,\n  PaperPlaneTiltIcon,\n  PlusIcon,\n  StopIcon,\n  TrashIcon,\n  WarningIcon,\n  XIcon,\n} from \"@phosphor-icons/react\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport type { AgentUsageSummary } from \"agentstart/agent\";\nimport type {\n  BlobFile,\n  BlobFileList,\n  QueuedAgentMessage,\n} from \"agentstart/client\";\nimport {\n  useAgentStartContext,\n  useAgentStore,\n  useBlobFiles,\n  useDataPart,\n} from \"agentstart/client\";\nimport { type FileUIPart, isFileUIPart } from \"ai\";\nimport { nanoid } from \"nanoid\";\nimport {\n  type ChangeEvent,\n  type ClipboardEventHandler,\n  type FormEvent,\n  type FormEventHandler,\n  Fragment,\n  type HTMLAttributes,\n  type KeyboardEventHandler,\n  type ReactNode,\n  type RefObject,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n} from \"react\";\nimport {\n  Alert,\n  AlertAction,\n  AlertDescription,\n  AlertTitle,\n} from \"@/components/ui/alert\";\nimport { Button } from \"@/components/ui/button\";\nimport { Menu, MenuItem, MenuPopup, MenuTrigger } from \"@/components/ui/menu\";\nimport {\n  PreviewCard,\n  PreviewCardPopup,\n  PreviewCardTrigger,\n} from \"@/components/ui/preview-card\";\nimport { Spinner } from \"@/components/ui/spinner\";\nimport type { Textarea } from \"@/components/ui/textarea\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  Context,\n  ContextCacheUsage,\n  ContextContent,\n  ContextContentBody,\n  ContextContentFooter,\n  ContextContentHeader,\n  ContextInputUsage,\n  ContextOutputUsage,\n  ContextReasoningUsage,\n  ContextTrigger,\n} from \"./context\";\nimport { ModelSelector } from \"./model-selector\";\nimport {\n  Queue,\n  QueueItem,\n  QueueItemAction,\n  QueueItemActions,\n  QueueItemAttachment,\n  QueueItemContent,\n  QueueItemDescription,\n  QueueItemFile,\n  QueueItemIndicator,\n  QueueSection,\n  QueueSectionContent,\n  QueueSectionLabel,\n  QueueSectionTrigger,\n} from \"./queue\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface MaxTurnsReachedRenderContext {\n  maxTurns: number;\n  usedTurns: number;\n  threadId?: string;\n  onNavigateHome: () => void;\n}\n\nexport interface PromptInputProps {\n  className?: string;\n  initialUsage?: AgentUsageSummary;\n  layout?: PromptInputLayout;\n  showUsage?: boolean;\n  renderMaxTurnsReached?: (context: MaxTurnsReachedRenderContext) => ReactNode;\n}\n\ntype SendState = \"idle\" | \"streaming\" | \"uploading\";\n\nexport type PromptInputLayout = \"default\" | \"mobile\";\n\ntype PromptActionButtonProps = {\n  className?: string;\n  input: string;\n  attachmentsCount: number;\n  sendState: SendState;\n  isPending: boolean;\n  hasError: boolean;\n  onStop?: () => void | Promise<void>;\n  disabled?: boolean;\n};\n\ntype AddAttachmentsMenuProps = {\n  onOpenFileDialog: () => void;\n  disabled?: boolean;\n};\n\ntype UsageDisplayProps = {\n  summary: AgentUsageSummary;\n};\n\ntype MessageQueueProps = {\n  messageQueue: QueuedAgentMessage[];\n  onSend: (id: string) => void;\n  onRemove: (id: string) => void;\n  onMove: (id: string, direction: \"up\" | \"down\") => void;\n};\n\ntype PromptInputAttachmentProps = HTMLAttributes<HTMLDivElement> & {\n  data: FileUIPart & { id: string };\n  onRemove: (id: string) => void;\n};\n\ntype PromptInputAttachmentsProps = Omit<\n  HTMLAttributes<HTMLDivElement>,\n  \"children\"\n> & {\n  files: (FileUIPart & { id: string })[];\n  children: (attachment: FileUIPart & { id: string }) => ReactNode;\n};\n\ntype PromptInputMessage = {\n  text?: string;\n  files?: FileUIPart[];\n};\n\ntype PromptInputFormProps = Omit<\n  HTMLAttributes<HTMLFormElement>,\n  \"onSubmit\"\n> & {\n  accept?: string;\n  multiple?: boolean;\n  globalDrop?: boolean;\n  attachments: (FileUIPart & { id: string })[];\n  onAddFiles: (files: File[] | FileList) => void;\n  onClearFiles: () => void;\n  fileInputRef?: RefObject<HTMLInputElement | null>;\n  onSubmit: (\n    message: PromptInputMessage,\n    event: FormEvent<HTMLFormElement>,\n  ) => void | Promise<void>;\n  disabled?: boolean;\n};\n\ntype PromptInputTextareaProps = React.ComponentProps<typeof Textarea> & {\n  value: string;\n  onChange: (e: ChangeEvent<HTMLTextAreaElement>) => void;\n  attachments: (FileUIPart & { id: string })[];\n  onRemoveAttachment: (id: string) => void;\n  onAddFiles: (files: File[]) => void;\n  layout?: PromptInputLayout;\n};\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\nfunction summarizeQueuedMessage(queued: QueuedAgentMessage): string {\n  const raw = queued.text?.trim() ?? \"\";\n  const attachmentsCount = queued.files?.length ?? 0;\n\n  if (!raw) {\n    return attachmentsCount === 1\n      ? \"Queued attachment\"\n      : attachmentsCount > 0\n        ? `${attachmentsCount} queued attachments`\n        : \"Queued message\";\n  }\n\n  const firstLine = raw.split(\"\\n\")[0]?.trim() || \"Queued message\";\n  return firstLine.length > 80 ? `${firstLine.slice(0, 77)}…` : firstLine;\n}\n\nfunction summarizeQueuedRemainder(queued: QueuedAgentMessage): string {\n  const raw = queued.text?.trim() ?? \"\";\n  if (!raw) return \"\";\n\n  const lines = raw.split(\"\\n\").filter((line) => line.trim());\n  if (lines.length <= 1) return \"\";\n\n  const remainder = lines.slice(1).join(\" \").replace(/\\s+/g, \" \").trim();\n  return remainder.length > 120 ? `${remainder.slice(0, 117)}…` : remainder;\n}\n\n// ============================================================================\n// Small Utility Components\n// ============================================================================\n\nfunction PromptActionButton({\n  className,\n  input,\n  attachmentsCount,\n  sendState,\n  isPending,\n  hasError,\n  onStop,\n  disabled = false,\n}: PromptActionButtonProps) {\n  const hasText = input.trim().length > 0;\n  const hasAttachments = attachmentsCount > 0;\n  const isStreaming = sendState === \"streaming\";\n  const isUploading = sendState === \"uploading\";\n  const isStopButton = sendState === \"streaming\";\n  const forceDisable = disabled && !isStopButton;\n  const shouldDisable =\n    forceDisable ||\n    (!isStreaming && !hasText && !hasAttachments) ||\n    isUploading;\n  const buttonType = isStopButton ? \"button\" : \"submit\";\n\n  const icon = useMemo(() => {\n    if (hasError) return <BugIcon className=\"size-4.5\" weight=\"duotone\" />;\n    if (isStreaming) return <StopIcon className=\"size-4.5\" weight=\"bold\" />;\n    if (isUploading) return <Spinner className=\"size-4.5\" />;\n    if (isPending) return <Spinner className=\"size-4.5\" />;\n    return <ArrowUpIcon className=\"size-4.5\" weight=\"bold\" />;\n  }, [hasError, isStreaming, isUploading, isPending]);\n\n  return (\n    <Button\n      aria-label={isStopButton ? \"Stop\" : \"Submit\"}\n      className={className}\n      disabled={shouldDisable}\n      onClick={isStopButton ? onStop : undefined}\n      size=\"icon-sm\"\n      type={buttonType}\n      variant=\"default\"\n    >\n      {icon}\n    </Button>\n  );\n}\n\nfunction AddAttachmentsMenu({\n  onOpenFileDialog,\n  disabled = false,\n}: AddAttachmentsMenuProps) {\n  return (\n    <div className=\"flex items-center gap-1\">\n      <Menu>\n        <MenuTrigger\n          render={\n            <Button\n              disabled={disabled}\n              size=\"icon-sm\"\n              type=\"button\"\n              variant=\"outline\"\n            />\n          }\n        >\n          <PlusIcon className=\"size-4\" weight=\"bold\" />\n        </MenuTrigger>\n        <MenuPopup align=\"start\">\n          <MenuItem\n            onClick={(e) => {\n              e.preventDefault();\n              if (disabled) {\n                return;\n              }\n              onOpenFileDialog();\n            }}\n            aria-disabled={disabled}\n          >\n            <ImageIcon className=\"mr-2 size-4\" weight=\"duotone\" /> Add photos or\n            files\n          </MenuItem>\n        </MenuPopup>\n      </Menu>\n    </div>\n  );\n}\n\nfunction UsageDisplay({ summary }: UsageDisplayProps) {\n  return (\n    <div className=\"flex w-full justify-end\">\n      <Context\n        maxTokens={summary.maxTokens}\n        modelId={summary.modelId}\n        usage={summary.usage}\n        usedTokens={summary.usedTokens}\n      >\n        <ContextTrigger className=\"gap-1\" />\n        <ContextContent className=\"flex w-full max-w-xs flex-col lg:max-w-sm\">\n          <ContextContentHeader />\n          <ContextContentBody className=\"space-y-2\">\n            <ContextInputUsage />\n            <ContextOutputUsage />\n            <ContextReasoningUsage />\n            <ContextCacheUsage />\n          </ContextContentBody>\n          <ContextContentFooter />\n        </ContextContent>\n      </Context>\n    </div>\n  );\n}\n\ntype MaxTurnsReachedNoticeProps = {\n  context: MaxTurnsReachedRenderContext;\n  message?: string;\n  render?: (context: MaxTurnsReachedRenderContext) => ReactNode;\n};\n\nfunction MaxTurnsReachedNotice({\n  context,\n  message,\n  render,\n}: MaxTurnsReachedNoticeProps) {\n  if (render) {\n    return <div className=\"mb-3 w-full\">{render(context)}</div>;\n  }\n\n  const limitDescription =\n    message ??\n    `You have reached the maximum of ${context.maxTurns} turns in this conversation.`;\n\n  return (\n    <Alert className=\"mx-auto mb-3 w-[90%] bg-secondary sm:w-[95%] dark:bg-secondary\">\n      <WarningIcon weight=\"duotone\" className=\"size-4\" />\n      <AlertTitle>Conversation limit reached</AlertTitle>\n      <AlertDescription>\n        <span className=\"text-muted-foreground text-xs\">\n          Used {context.usedTurns}/{context.maxTurns} turns\n        </span>\n        {limitDescription}\n      </AlertDescription>\n      <AlertAction>\n        <Button\n          onClick={context.onNavigateHome}\n          size=\"sm\"\n          type=\"button\"\n          variant=\"outline\"\n        >\n          Return home\n        </Button>\n      </AlertAction>\n    </Alert>\n  );\n}\n\n// ============================================================================\n// Attachment Components\n// ============================================================================\n\nfunction PromptInputAttachment({\n  data,\n  onRemove,\n  className,\n  ...props\n}: PromptInputAttachmentProps) {\n  const mediaType =\n    data.mediaType?.startsWith(\"image/\") && data.url ? \"image\" : \"file\";\n\n  const AttachmentIcon = useMemo(() => {\n    switch (mediaType) {\n      case \"image\": {\n        return <ImageIcon className=\"size-4.5 shrink-0\" weight=\"duotone\" />;\n      }\n      case \"file\": {\n        return <FileIcon className=\"size-4.5 shrink-0\" weight=\"duotone\" />;\n      }\n    }\n  }, [mediaType, data]);\n\n  const AttachmentPreview = useMemo(() => {\n    switch (mediaType) {\n      case \"image\": {\n        return (\n          <div className=\"max-w-60\">\n            <img src={data.url} alt={data.filename} className=\"object-cover\" />\n          </div>\n        );\n      }\n      case \"file\": {\n        return (\n          <div className=\"text-muted-foreground text-xs\">\n            <h4 className=\"wrap-break-word max-w-60 overflow-hidden whitespace-normal text-left font-semibold text-sm\">\n              {data.filename || \"Unknown file\"}\n            </h4>\n            {data.mediaType && <div>{data.mediaType}</div>}\n          </div>\n        );\n      }\n    }\n  }, [mediaType, data]);\n\n  return (\n    <div\n      className={cn(\n        \"group relative h-8 w-auto max-w-full rounded-lg border bg-background hover:bg-accent\",\n        className,\n      )}\n      key={data.id}\n      {...props}\n    >\n      <PreviewCard delay={0}>\n        <PreviewCardTrigger\n          className=\"min-w-0 flex-1\"\n          render={\n            <div className=\"flex size-full max-w-full cursor-pointer items-center justify-start gap-1 overflow-hidden px-2 text-muted-foreground\">\n              {AttachmentIcon}\n              <h4 className=\"w-full max-w-40 truncate text-left font-medium text-sm [direction:rtl]\">\n                {data.filename || \"Unknown file\"}\n              </h4>\n            </div>\n          }\n        />\n        <PreviewCardPopup>{AttachmentPreview}</PreviewCardPopup>\n      </PreviewCard>\n\n      <Button\n        aria-label=\"Remove attachment\"\n        className=\"-right-1.5 -top-1.5 absolute size-5 rounded-full opacity-0 group-hover:opacity-100\"\n        onClick={() => onRemove(data.id)}\n        size=\"icon\"\n        type=\"button\"\n        variant=\"outline\"\n      >\n        <XIcon className=\"size-3\" weight=\"bold\" />\n      </Button>\n    </div>\n  );\n}\n\nfunction PromptInputAttachments({\n  files,\n  className,\n  children,\n  ...props\n}: PromptInputAttachmentsProps) {\n  if (files.length === 0) return null;\n\n  return (\n    <div\n      className={cn(\n        \"overflow-hidden transition-[height] duration-300 ease-out\",\n        className,\n      )}\n      {...props}\n    >\n      <div className=\"space-y-2 px-2 pt-1 pb-2\">\n        <div className=\"flex flex-wrap gap-2\">\n          {files.map((file) => (\n            <Fragment key={file.id}>{children(file)}</Fragment>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// Form Components\n// ============================================================================\n\nfunction PromptInputTextarea({\n  value,\n  onChange,\n  attachments,\n  onRemoveAttachment,\n  onAddFiles,\n  className,\n  layout = \"default\",\n  placeholder = \"Ask anything\",\n  disabled = false,\n  ...props\n}: PromptInputTextareaProps) {\n  const [isComposing, setIsComposing] = useState(false);\n  const isMobileLayout = layout === \"mobile\";\n\n  const handleKeyDown: KeyboardEventHandler<HTMLTextAreaElement> = (e) => {\n    if (e.key === \"Enter\") {\n      if (isComposing || e.nativeEvent.isComposing) return;\n      if (e.shiftKey) return;\n      e.preventDefault();\n      e.currentTarget.form?.requestSubmit();\n    }\n\n    // Remove last attachment when Backspace is pressed and textarea is empty\n    if (\n      e.key === \"Backspace\" &&\n      e.currentTarget.value === \"\" &&\n      attachments.length > 0\n    ) {\n      e.preventDefault();\n      const lastAttachment = attachments.at(-1);\n      if (lastAttachment) {\n        onRemoveAttachment(lastAttachment.id);\n      }\n    }\n  };\n\n  const handlePaste: ClipboardEventHandler<HTMLTextAreaElement> = (event) => {\n    if (disabled) {\n      event.preventDefault();\n      return;\n    }\n    const items = event.clipboardData?.items;\n    if (!items) return;\n\n    const files: File[] = [];\n    for (const item of items) {\n      if (item.kind === \"file\") {\n        const file = item.getAsFile();\n        if (file) files.push(file);\n      }\n    }\n\n    if (files.length > 0) {\n      event.preventDefault();\n      onAddFiles(files);\n    }\n  };\n\n  return (\n    <textarea\n      data-slot=\"textarea\"\n      className={cn(\n        \"field-sizing-content w-full resize-none rounded-[inherit] px-[calc(--spacing(3)-1px)] py-[calc(--spacing(1.5)-1px)] outline-none [scrollbar-color:var(--accent)_transparent] [scrollbar-width:thin]\",\n        isMobileLayout ? \"min-h-10\" : \"min-h-17.5 max-sm:min-h-20.5\",\n        className,\n      )}\n      name=\"message\"\n      onCompositionEnd={() => setIsComposing(false)}\n      onCompositionStart={() => setIsComposing(true)}\n      onKeyDown={handleKeyDown}\n      onPaste={handlePaste}\n      placeholder={placeholder}\n      value={value}\n      onChange={onChange}\n      disabled={disabled}\n      {...props}\n    />\n  );\n}\n\nfunction PromptInputForm({\n  className,\n  accept,\n  multiple,\n  globalDrop,\n  attachments,\n  onAddFiles,\n  onClearFiles,\n  fileInputRef,\n  onSubmit,\n  children,\n  disabled = false,\n  ...props\n}: PromptInputFormProps) {\n  const internalInputRef = useRef<HTMLInputElement | null>(null);\n  const inputRef = fileInputRef || internalInputRef;\n  const formRef = useRef<HTMLFormElement | null>(null);\n  const anchorRef = useRef<HTMLSpanElement>(null);\n\n  useEffect(() => {\n    const root = anchorRef.current?.closest(\"form\");\n    if (root instanceof HTMLFormElement) {\n      formRef.current = root;\n    }\n  }, []);\n\n  const handleChange = (event: ChangeEvent<HTMLInputElement>) => {\n    if (disabled) return;\n    if (event.currentTarget.files) {\n      onAddFiles(event.currentTarget.files);\n    }\n  };\n\n  const handleSubmit: FormEventHandler<HTMLFormElement> = async (event) => {\n    event.preventDefault();\n\n    const form = event.currentTarget;\n    form.reset();\n\n    if (disabled) {\n      return;\n    }\n\n    // Convert blob URLs to data URLs\n    const convertedFiles = await Promise.all(\n      attachments.map(async ({ id, ...item }) => {\n        if (item.url?.startsWith(\"blob:\")) {\n          const response = await fetch(item.url);\n          const blob = await response.blob();\n          const dataUrl = await new Promise<string>((resolve, reject) => {\n            const reader = new FileReader();\n            reader.onloadend = () => resolve(reader.result as string);\n            reader.onerror = reject;\n            reader.readAsDataURL(blob);\n          });\n          return { ...item, url: dataUrl };\n        }\n        return item;\n      }),\n    );\n\n    try {\n      const textareas = form.querySelectorAll(\"textarea[name='message']\");\n      const text = (textareas[0] as HTMLTextAreaElement)?.value || \"\";\n      const result = onSubmit({ text, files: convertedFiles }, event);\n      await result;\n      onClearFiles();\n    } catch {\n      // Don't clear on error\n    }\n  };\n\n  // Drag & drop on form\n  useEffect(() => {\n    const form = formRef.current;\n    if (!form || disabled) return;\n\n    const onDragOver = (e: DragEvent) => {\n      if (e.dataTransfer?.types?.includes(\"Files\")) {\n        e.preventDefault();\n      }\n    };\n    const onDrop = (e: DragEvent) => {\n      if (e.dataTransfer?.types?.includes(\"Files\")) {\n        e.preventDefault();\n      }\n      if (e.dataTransfer?.files && e.dataTransfer.files.length > 0) {\n        onAddFiles(e.dataTransfer.files);\n      }\n    };\n    form.addEventListener(\"dragover\", onDragOver);\n    form.addEventListener(\"drop\", onDrop);\n    return () => {\n      form.removeEventListener(\"dragover\", onDragOver);\n      form.removeEventListener(\"drop\", onDrop);\n    };\n  }, [disabled, onAddFiles]);\n\n  // Global drop (opt-in)\n  useEffect(() => {\n    if (!globalDrop || disabled) return;\n\n    const onDragOver = (e: DragEvent) => {\n      if (e.dataTransfer?.types?.includes(\"Files\")) {\n        e.preventDefault();\n      }\n    };\n    const onDrop = (e: DragEvent) => {\n      if (e.dataTransfer?.types?.includes(\"Files\")) {\n        e.preventDefault();\n      }\n      if (e.dataTransfer?.files && e.dataTransfer.files.length > 0) {\n        onAddFiles(e.dataTransfer.files);\n      }\n    };\n    document.addEventListener(\"dragover\", onDragOver);\n    document.addEventListener(\"drop\", onDrop);\n    return () => {\n      document.removeEventListener(\"dragover\", onDragOver);\n      document.removeEventListener(\"drop\", onDrop);\n    };\n  }, [disabled, onAddFiles, globalDrop]);\n\n  // Cleanup blob URLs\n  useEffect(\n    () => () => {\n      for (const f of attachments) {\n        if (f.url) URL.revokeObjectURL(f.url);\n      }\n    },\n    [attachments],\n  );\n\n  return (\n    <>\n      <span aria-hidden=\"true\" className=\"hidden\" ref={anchorRef} />\n      <input\n        accept={accept}\n        aria-label=\"Upload files\"\n        className=\"hidden\"\n        multiple={multiple}\n        onChange={handleChange}\n        ref={inputRef}\n        title=\"Upload files\"\n        type=\"file\"\n        disabled={disabled}\n      />\n      <form\n        aria-disabled={disabled}\n        className={cn(\"w-full\", disabled ? \"grayscale\" : undefined, className)}\n        onSubmit={handleSubmit}\n        {...props}\n      >\n        {children}\n      </form>\n    </>\n  );\n}\n\n// ============================================================================\n// MessageQueue Component\n// ============================================================================\n\nfunction MessageQueue({\n  messageQueue,\n  onSend,\n  onRemove,\n  onMove,\n}: MessageQueueProps) {\n  if (messageQueue.length === 0) return null;\n\n  return (\n    <Queue className=\"relative mx-auto w-[90%] rounded-b-none border-none bg-secondary px-1 shadow-none sm:w-[95%]\">\n      <QueueSection>\n        <QueueSectionTrigger className=\"py-1\">\n          <QueueSectionLabel count={messageQueue.length} label=\"Queued\" />\n        </QueueSectionTrigger>\n        <QueueSectionContent className=\"pt-1\">\n          <div className=\"flex flex-col gap-1\">\n            {messageQueue.map((queued, index) => {\n              const summary = summarizeQueuedMessage(queued);\n              const remainder = summarizeQueuedRemainder(queued);\n              const attachments =\n                (queued.files instanceof FileList\n                  ? Array.from(queued.files)\n                  : queued.files) ?? [];\n              const attachmentsLabel =\n                attachments.length > 0\n                  ? `${attachments.length} attachment${attachments.length > 1 ? \"s\" : \"\"}`\n                  : null;\n\n              return (\n                <QueueItem\n                  key={queued.id}\n                  className=\"flex flex-row items-center gap-2 py-0.5 hover:bg-background\"\n                >\n                  <QueueItemIndicator />\n                  <QueueItemContent title={summary}>{summary}</QueueItemContent>\n                  <QueueItemAction\n                    aria-label=\"Remove message from queue\"\n                    onClick={() => onRemove(queued.id)}\n                  >\n                    <TrashIcon className=\"size-3\" weight=\"duotone\" />\n                  </QueueItemAction>\n                  <QueueItemAction\n                    aria-label=\"Send message now\"\n                    onClick={() => onSend(queued.id)}\n                  >\n                    <PaperPlaneTiltIcon className=\"size-3\" weight=\"duotone\" />\n                  </QueueItemAction>\n                  {remainder ? (\n                    <QueueItemDescription>{remainder}</QueueItemDescription>\n                  ) : null}\n                  {attachmentsLabel ? (\n                    <QueueItemDescription>\n                      {attachmentsLabel}\n                    </QueueItemDescription>\n                  ) : null}\n                  <QueueItemActions>\n                    {index > 0 ? (\n                      <QueueItemAction\n                        aria-label=\"Move message up\"\n                        onClick={() => onMove(queued.id, \"up\")}\n                      >\n                        <ArrowUpIcon className=\"size-3\" weight=\"bold\" />\n                      </QueueItemAction>\n                    ) : null}\n                    {index < messageQueue.length - 1 ? (\n                      <QueueItemAction\n                        aria-label=\"Move message down\"\n                        onClick={() => onMove(queued.id, \"down\")}\n                      >\n                        <ArrowDownIcon className=\"size-3\" weight=\"bold\" />\n                      </QueueItemAction>\n                    ) : null}\n                  </QueueItemActions>\n\n                  {attachments.length > 0 ? (\n                    <QueueItemAttachment>\n                      {attachments.map((file, fileIndex) => {\n                        const filename =\n                          file instanceof File\n                            ? file.name\n                            : (file.filename ??\n                              file.mediaType ??\n                              `Attachment ${fileIndex + 1}`);\n                        const key = `${queued.id}-attachment-${fileIndex}`;\n                        return (\n                          <QueueItemFile key={key} title={filename}>\n                            {filename}\n                          </QueueItemFile>\n                        );\n                      })}\n                    </QueueItemAttachment>\n                  ) : null}\n                </QueueItem>\n              );\n            })}\n          </div>\n        </QueueSectionContent>\n      </QueueSection>\n    </Queue>\n  );\n}\n\n// ============================================================================\n// Main PromptInput Component\n// ============================================================================\n\nexport function PromptInput({\n  className,\n  initialUsage,\n  layout = \"default\",\n  showUsage = true,\n  renderMaxTurnsReached,\n}: PromptInputProps = {}) {\n  const {\n    orpc,\n    navigate,\n    threadId,\n    setThreadId,\n    config: appConfig,\n  } = useAgentStartContext();\n  const queryClient = useQueryClient();\n  const isMobileLayout = layout === \"mobile\";\n\n  // Input state\n  const [input, setInput] = useState(\"\");\n\n  // Attachments state\n  const [attachments, setAttachments] = useState<\n    (FileUIPart & { id: string })[]\n  >([]);\n  const fileInputRef = useRef<HTMLInputElement | null>(null);\n\n  // Agent store\n  const storeKey = threadId ?? \"default\";\n  const status = useAgentStore((state) => state.status, storeKey);\n  const id = useAgentStore((state) => state.id, storeKey);\n  const stop = useAgentStore((state) => state.stop, storeKey);\n  const sendMessage = useAgentStore((state) => state.sendMessage, storeKey);\n  const messageQueue = useAgentStore((state) => state.messageQueue, storeKey);\n  const messages = useAgentStore((state) => state.messages, storeKey);\n  const enqueueQueuedMessage = useAgentStore(\n    (state) => state.enqueueQueuedMessage,\n    storeKey,\n  );\n  const takeQueuedMessageById = useAgentStore(\n    (state) => state.takeQueuedMessageById,\n    storeKey,\n  );\n  const removeQueuedMessage = useAgentStore(\n    (state) => state.removeQueuedMessage,\n    storeKey,\n  );\n  const moveQueuedMessage = useAgentStore(\n    (state) => state.moveQueuedMessage,\n    storeKey,\n  );\n  const prependQueuedMessage = useAgentStore(\n    (state) => state.prependQueuedMessage,\n    storeKey,\n  );\n  const newThreadDraft = useAgentStore((state) => state.newThreadDraft);\n  const setNewThreadDraft = useAgentStore((state) => state.setNewThreadDraft);\n\n  // Usage tracking\n  const [usagePart] = useDataPart<\"data-agentstart-usage\">(\n    \"data-agentstart-usage\",\n    storeKey,\n  );\n  const usageSummary = usagePart ?? initialUsage ?? null;\n  const shouldShowUsage =\n    showUsage && Boolean(threadId) && Boolean(usageSummary);\n\n  const [maxTurnsPart] = useDataPart<\"data-agentstart-max_turns_reached\">(\n    \"data-agentstart-max_turns_reached\",\n    storeKey,\n  );\n  const configuredMaxTurns = appConfig?.limits?.maxTurns ?? null;\n  const assistantTurns = useMemo(() => {\n    return messages.reduce((total, message) => {\n      return message.role === \"assistant\" ? total + 1 : total;\n    }, 0);\n  }, [messages]);\n  const effectiveMaxTurns = maxTurnsPart?.maxTurns ?? configuredMaxTurns;\n  const usedTurns = maxTurnsPart?.usedTurns ?? assistantTurns;\n  const hasReachedMaxTurns =\n    typeof effectiveMaxTurns === \"number\" &&\n    effectiveMaxTurns > 0 &&\n    usedTurns >= effectiveMaxTurns;\n  const maxTurnsContext = useMemo(() => {\n    if (!hasReachedMaxTurns || typeof effectiveMaxTurns !== \"number\") {\n      return null;\n    }\n\n    return {\n      maxTurns: effectiveMaxTurns,\n      usedTurns: Math.min(usedTurns, effectiveMaxTurns),\n      threadId,\n      onNavigateHome: () => navigate(\"/\"),\n    } satisfies MaxTurnsReachedRenderContext;\n  }, [effectiveMaxTurns, hasReachedMaxTurns, navigate, threadId, usedTurns]);\n  const maxTurnsMessage =\n    maxTurnsPart?.message ??\n    (typeof effectiveMaxTurns === \"number\"\n      ? `This conversation reached the maximum of ${effectiveMaxTurns} turns.`\n      : undefined);\n  const isInputDisabled = Boolean(maxTurnsContext);\n\n  // Blob files\n  const {\n    files: blobFiles,\n    setFiles: setBlobFiles,\n    processFiles,\n    clearFiles,\n    isUploading,\n  } = useBlobFiles();\n\n  const createThreadMutation = useMutation(\n    orpc.thread.create.mutationOptions(),\n  );\n\n  // Attachment handlers\n  const addFiles = (files: File[] | FileList) => {\n    const incoming = Array.from(files);\n    if (incoming.length === 0) return;\n\n    setAttachments((prev) =>\n      prev.concat(\n        incoming.map((file) => ({\n          id: nanoid(),\n          type: \"file\" as const,\n          url: URL.createObjectURL(file),\n          mediaType: file.type,\n          filename: file.name,\n        })),\n      ),\n    );\n  };\n\n  const removeAttachment = (id: string) => {\n    setAttachments((prev) => {\n      const found = prev.find((f) => f.id === id);\n      if (found?.url) URL.revokeObjectURL(found.url);\n      return prev.filter((f) => f.id !== id);\n    });\n  };\n\n  const clearAttachments = () => {\n    setAttachments((prev) => {\n      for (const f of prev) if (f.url) URL.revokeObjectURL(f.url);\n      return [];\n    });\n  };\n\n  const openFileDialog = () => {\n    if (isInputDisabled) return;\n    fileInputRef.current?.click();\n  };\n\n  // Sync attachments with blob files\n  useEffect(() => {\n    if (attachments.length === 0) {\n      setBlobFiles([]);\n      return;\n    }\n\n    const normalized: BlobFile[] = attachments.map(\n      ({ id: _id, ...rest }) => rest,\n    );\n    setBlobFiles(normalized);\n  }, [attachments, setBlobFiles]);\n\n  const handleMessageSubmit = async (message: {\n    text?: string;\n    files?: BlobFileList;\n  }) => {\n    if (isInputDisabled) return;\n\n    let files: FileList | FileUIPart[] | undefined;\n\n    if (message?.files && Array.isArray(message.files)) {\n      if (message.files.every((file) => file instanceof File)) {\n        const dataTransfer = new DataTransfer();\n        for (const file of message.files) {\n          dataTransfer.items.add(file);\n        }\n        files = dataTransfer.files;\n      } else if (\n        message.files.every(\n          (file) => !(file instanceof File) && isFileUIPart(file),\n        )\n      ) {\n        files = message.files as FileUIPart[];\n      }\n    }\n\n    return await sendMessage(\n      { text: message?.text ?? \"\", files },\n      { body: { threadId } },\n    );\n  };\n\n  const handleSubmit = async (message: PromptInputMessage) => {\n    if (isInputDisabled) {\n      return;\n    }\n    const isBusy = [\"streaming\", \"submitted\"].includes(status);\n    const hasText = Boolean(message.text?.trim());\n    const hasAttachments = Boolean(blobFiles.length);\n    if (!(hasText || hasAttachments)) return;\n\n    let processedFiles: BlobFileList | undefined;\n    try {\n      processedFiles = await processFiles();\n    } catch (error) {\n      console.error(\n        error instanceof Error ? error.message : \"File processing failed\",\n      );\n      return;\n    }\n\n    if (threadId) {\n      const trimmedText = message.text?.trim() ?? \"\";\n      const queueText = trimmedText.length > 0 ? trimmedText : undefined;\n      let queueFiles: FileUIPart[] | undefined;\n      if (processedFiles) {\n        const fileArray =\n          processedFiles instanceof FileList\n            ? Array.from(processedFiles)\n            : processedFiles;\n        queueFiles = fileArray.filter(\n          (file): file is FileUIPart => \"type\" in file && file.type === \"file\",\n        );\n      }\n      const shouldQueue = isBusy || messageQueue.length > 0;\n\n      if (shouldQueue) {\n        enqueueQueuedMessage({\n          text: queueText,\n          files: queueFiles,\n        });\n        setInput(\"\");\n        clearFiles();\n        clearAttachments();\n        return;\n      }\n    }\n\n    if (isBusy) {\n      stop();\n      return;\n    }\n\n    if (threadId) {\n      setInput(\"\");\n      clearFiles();\n      clearAttachments();\n      try {\n        await handleMessageSubmit({\n          text: message.text?.trim() ?? \"\",\n          files: processedFiles,\n        });\n      } catch (error) {\n        console.error(\"Failed to send message:\", error);\n        // Restore input on error\n        setInput(message.text ?? \"\");\n      }\n    } else {\n      const trimmedText = message.text?.trim() ?? \"\";\n      setNewThreadDraft({\n        text: trimmedText,\n        files: processedFiles,\n      });\n\n      try {\n        setInput(\"\");\n        clearFiles();\n        clearAttachments();\n        const { threadId: newThreadId } =\n          await createThreadMutation.mutateAsync({\n            visibility: \"public\",\n          });\n\n        // Update context state (single source of truth)\n        setThreadId(newThreadId);\n\n        navigate(`/thread/${newThreadId}`);\n        queryClient.invalidateQueries(\n          orpc.thread.list.queryOptions({ input: {} }),\n        );\n      } catch (error) {\n        setNewThreadDraft(null);\n        setInput(message.text ?? \"\");\n        throw error;\n      }\n    }\n  };\n\n  const isPending = threadId\n    ? status === \"submitted\"\n    : createThreadMutation.isPending;\n  const isStreaming = status === \"streaming\";\n  const hasError = threadId ? false : createThreadMutation.isError;\n  const sendState: SendState = isStreaming\n    ? \"streaming\"\n    : isUploading\n      ? \"uploading\"\n      : \"idle\";\n\n  const handleSendQueuedMessage = async (queuedId: string) => {\n    if (!threadId || isInputDisabled) return;\n    const queued = takeQueuedMessageById(queuedId);\n    if (!queued) return;\n    if ([\"streaming\", \"submitted\"].includes(status)) {\n      try {\n        await stop();\n      } catch (error) {\n        console.error(\n          \"Failed to stop active message before sending queued item\",\n          error,\n        );\n      }\n    }\n    try {\n      await handleMessageSubmit({\n        text: queued.text ?? \"\",\n        files: queued.files,\n      });\n    } catch (error) {\n      console.error(\"Failed to send queued message immediately\", error);\n      prependQueuedMessage(queued);\n    }\n  };\n\n  useEffect(() => {\n    if (!threadId || !id || !newThreadDraft || isInputDisabled) return;\n\n    const { text, files } = newThreadDraft;\n    const storedText = text?.trim() ?? \"\";\n    const fileCount =\n      files instanceof FileList\n        ? files.length\n        : Array.isArray(files)\n          ? files.length\n          : 0;\n\n    if (!storedText && fileCount === 0) return;\n\n    setNewThreadDraft(null);\n\n    void (async () => {\n      try {\n        await handleMessageSubmit({ text: storedText, files });\n      } catch {\n        setNewThreadDraft({ text: storedText, files });\n      }\n    })();\n  }, [\n    handleMessageSubmit,\n    id,\n    isInputDisabled,\n    newThreadDraft,\n    setNewThreadDraft,\n    threadId,\n  ]);\n\n  return (\n    <div className=\"mx-auto flex w-full flex-col px-4 sm:min-w-[390px] sm:max-w-3xl\">\n      {maxTurnsContext ? (\n        <MaxTurnsReachedNotice\n          context={maxTurnsContext}\n          message={maxTurnsMessage}\n          render={renderMaxTurnsReached}\n        />\n      ) : null}\n      <MessageQueue\n        messageQueue={messageQueue}\n        onSend={handleSendQueuedMessage}\n        onRemove={removeQueuedMessage}\n        onMove={moveQueuedMessage}\n      />\n      <PromptInputForm\n        globalDrop\n        multiple\n        attachments={attachments}\n        onAddFiles={addFiles}\n        onClearFiles={clearAttachments}\n        fileInputRef={fileInputRef}\n        onSubmit={handleSubmit}\n        disabled={isInputDisabled}\n        className={cn(\n          \"mx-auto w-full max-w-full rounded-[22px] bg-secondary p-1.5 *:data-[slot=input-group]:rounded-[22px] sm:min-w-[390px] sm:max-w-3xl\",\n          className,\n        )}\n      >\n        <PromptInputAttachments files={attachments}>\n          {(attachment) => (\n            <PromptInputAttachment\n              data={attachment}\n              onRemove={removeAttachment}\n            />\n          )}\n        </PromptInputAttachments>\n\n        {/* Wrapper */}\n        <div\n          data-slot=\"textarea-control\"\n          className={cn(\n            \"field-sizing-content relative inline-flex max-h-60 w-full overflow-hidden rounded-[18px] border border-input bg-background bg-clip-padding text-base shadow-xs transition-all duration-300 has-focus-visible:has-aria-invalid:border-destructive/64 has-aria-invalid:border-destructive/36 has-focus-visible:border-ring has-disabled:opacity-64 sm:text-sm dark:bg-input/32 dark:bg-clip-border [&:has(:disabled,:focus-visible,[aria-invalid])]:shadow-none\",\n            isMobileLayout\n              ? \"min-h-10 flex-row items-end gap-2 px-4 py-2\"\n              : \"min-h-24 flex-col\",\n            className,\n          )}\n        >\n          {isMobileLayout ? (\n            <>\n              <div className=\"flex h-7 items-center gap-1\">\n                <AddAttachmentsMenu\n                  disabled={isInputDisabled}\n                  onOpenFileDialog={openFileDialog}\n                />\n                <ModelSelector />\n              </div>\n              <PromptInputTextarea\n                className=\"min-h-5.5 min-w-0 flex-1 rounded-none p-0 leading-none\"\n                placeholder=\"Ask anything\"\n                value={input}\n                onChange={(e) => setInput(e.target.value)}\n                attachments={attachments}\n                onRemoveAttachment={removeAttachment}\n                onAddFiles={addFiles}\n                autoFocus\n                layout={layout}\n                disabled={isInputDisabled}\n              />\n              <div className=\"flex h-7 shrink-0 items-center gap-2\">\n                {shouldShowUsage && usageSummary ? (\n                  <UsageDisplay summary={usageSummary} />\n                ) : null}\n\n                <PromptActionButton\n                  input={input}\n                  attachmentsCount={attachments.length}\n                  sendState={sendState}\n                  isPending={isPending}\n                  hasError={hasError}\n                  onStop={stop}\n                  disabled={isInputDisabled}\n                />\n              </div>\n            </>\n          ) : (\n            <>\n              <PromptInputTextarea\n                className=\"px-4 pt-2\"\n                placeholder=\"Ask anything\"\n                value={input}\n                onChange={(e) => setInput(e.target.value)}\n                attachments={attachments}\n                onRemoveAttachment={removeAttachment}\n                onAddFiles={addFiles}\n                autoFocus\n                layout={layout}\n                disabled={isInputDisabled}\n              />\n              <div className=\"flex w-full items-center justify-between gap-1 px-4 pb-3\">\n                <div className=\"flex items-center gap-1\">\n                  <AddAttachmentsMenu\n                    disabled={isInputDisabled}\n                    onOpenFileDialog={openFileDialog}\n                  />\n                  <ModelSelector />\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {shouldShowUsage && usageSummary ? (\n                    <UsageDisplay summary={usageSummary} />\n                  ) : null}\n\n                  <PromptActionButton\n                    input={input}\n                    attachmentsCount={attachments.length}\n                    sendState={sendState}\n                    isPending={isPending}\n                    hasError={hasError}\n                    onStop={stop}\n                    disabled={isInputDisabled}\n                  />\n                </div>\n              </div>\n            </>\n          )}\n        </div>\n      </PromptInputForm>\n    </div>\n  );\n}\n",
      "type": "registry:component",
      "target": "components/agent/prompt-input.tsx"
    },
    {
      "path": "src/registry/agentstart/context.tsx",
      "content": "/* agent-frontmatter:start\nAGENT: Model usage context widget\nPURPOSE: Display token and cost usage details for the current model\nUSAGE: import { Context, ContextTrigger, ContextContent } from \\\"@/components/agent/context\\\"\nEXPORTS: Context, ContextTrigger, ContextContent, ContextContentHeader, ContextContentBody, ContextContentFooter, ContextInputUsage, ContextOutputUsage, ContextReasoningUsage, ContextCacheUsage\nFEATURES:\n  - Calculates costs using Tokenlens estimates\n  - Provides hoverable preview card with token breakdown\nSEARCHABLE: token usage, cost estimator, context preview, agent usage widget\nagent-frontmatter:end */\n\n\"use client\";\n\nimport type { LanguageModelUsage } from \"ai\";\nimport { type ComponentProps, createContext, useContext } from \"react\";\nimport { getUsage } from \"tokenlens\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  PreviewCard,\n  PreviewCardPopup,\n  PreviewCardTrigger,\n} from \"@/components/ui/preview-card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { cn } from \"@/lib/utils\";\n\nconst PERCENT_MAX = 100;\nconst ICON_RADIUS = 10;\nconst ICON_VIEWBOX = 24;\nconst ICON_CENTER = 12;\nconst ICON_STROKE_WIDTH = 2;\n\ntype ContextSchema = {\n  usedTokens: number;\n  maxTokens: number;\n  usage?: LanguageModelUsage;\n  modelId?: string;\n};\n\nconst ContextContext = createContext<ContextSchema | null>(null);\n\nconst useContextValue = () => {\n  const context = useContext(ContextContext);\n\n  if (!context) {\n    throw new Error(\"Context components must be used within Context\");\n  }\n\n  return context;\n};\n\nexport type ContextProps = ComponentProps<typeof PreviewCard> & ContextSchema;\n\nexport const Context = ({\n  usedTokens,\n  maxTokens,\n  usage,\n  modelId,\n  ...props\n}: ContextProps) => (\n  <ContextContext.Provider\n    value={{\n      usedTokens,\n      maxTokens,\n      usage,\n      modelId,\n    }}\n  >\n    <PreviewCard closeDelay={0} delay={0} {...props} />\n  </ContextContext.Provider>\n);\n\nconst ContextIcon = () => {\n  const { usedTokens, maxTokens } = useContextValue();\n  const circumference = 2 * Math.PI * ICON_RADIUS;\n  const usedPercent = usedTokens / maxTokens;\n  const dashOffset = circumference * (1 - usedPercent);\n\n  return (\n    <svg\n      aria-label=\"Model context usage\"\n      height=\"20\"\n      role=\"img\"\n      style={{ color: \"currentcolor\" }}\n      viewBox={`0 0 ${ICON_VIEWBOX} ${ICON_VIEWBOX}`}\n      width=\"20\"\n    >\n      <circle\n        cx={ICON_CENTER}\n        cy={ICON_CENTER}\n        fill=\"none\"\n        opacity=\"0.25\"\n        r={ICON_RADIUS}\n        stroke=\"currentColor\"\n        strokeWidth={ICON_STROKE_WIDTH}\n      />\n      <circle\n        cx={ICON_CENTER}\n        cy={ICON_CENTER}\n        fill=\"none\"\n        opacity=\"0.7\"\n        r={ICON_RADIUS}\n        stroke=\"currentColor\"\n        strokeDasharray={`${circumference} ${circumference}`}\n        strokeDashoffset={dashOffset}\n        strokeLinecap=\"round\"\n        strokeWidth={ICON_STROKE_WIDTH}\n        style={{ transformOrigin: \"center\", transform: \"rotate(-90deg)\" }}\n      />\n    </svg>\n  );\n};\n\nexport type ContextTriggerProps = ComponentProps<typeof Button>;\n\nexport const ContextTrigger = ({ children, ...props }: ContextTriggerProps) => {\n  const { usedTokens, maxTokens } = useContextValue();\n  const usedPercent = usedTokens / maxTokens;\n  const renderedPercent = new Intl.NumberFormat(\"en-US\", {\n    style: \"percent\",\n    maximumFractionDigits: 1,\n  }).format(usedPercent);\n\n  return (\n    <PreviewCardTrigger\n      render={\n        <Button type=\"button\" variant=\"ghost\" {...props}>\n          {children || (\n            <>\n              <span className=\"font-medium text-muted-foreground\">\n                {renderedPercent}\n              </span>\n              <ContextIcon />\n            </>\n          )}\n        </Button>\n      }\n    />\n  );\n};\n\nexport type ContextContentProps = ComponentProps<typeof PreviewCardPopup>;\n\nexport const ContextContent = ({\n  className,\n  ...props\n}: ContextContentProps) => (\n  <PreviewCardPopup\n    className={cn(\"min-w-60 divide-y overflow-hidden p-0\", className)}\n    {...props}\n  />\n);\n\nexport type ContextContentHeader = ComponentProps<\"div\">;\n\nexport const ContextContentHeader = ({\n  children,\n  className,\n  ...props\n}: ContextContentHeader) => {\n  const { usedTokens, maxTokens } = useContextValue();\n  const usedPercent = usedTokens / maxTokens;\n  const displayPct = new Intl.NumberFormat(\"en-US\", {\n    style: \"percent\",\n    maximumFractionDigits: 1,\n  }).format(usedPercent);\n  const used = new Intl.NumberFormat(\"en-US\", {\n    notation: \"compact\",\n  }).format(usedTokens);\n  const total = new Intl.NumberFormat(\"en-US\", {\n    notation: \"compact\",\n  }).format(maxTokens);\n\n  return (\n    <div className={cn(\"w-full space-y-2 p-3\", className)} {...props}>\n      {children ?? (\n        <>\n          <div className=\"flex items-center justify-between gap-3 text-xs\">\n            <p>{displayPct}</p>\n            <p className=\"font-mono text-muted-foreground\">\n              {used} / {total}\n            </p>\n          </div>\n          <div className=\"space-y-2\">\n            <Progress className=\"bg-muted\" value={usedPercent * PERCENT_MAX} />\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nexport type ContextContentBody = ComponentProps<\"div\">;\n\nexport const ContextContentBody = ({\n  children,\n  className,\n  ...props\n}: ContextContentBody) => (\n  <div className={cn(\"w-full p-3\", className)} {...props}>\n    {children}\n  </div>\n);\n\nexport type ContextContentFooter = ComponentProps<\"div\">;\n\nexport const ContextContentFooter = ({\n  children,\n  className,\n  ...props\n}: ContextContentFooter) => {\n  const { modelId, usage } = useContextValue();\n  const costUSD = modelId\n    ? getUsage({\n        modelId,\n        usage: {\n          input: usage?.inputTokens ?? 0,\n          output: usage?.outputTokens ?? 0,\n        },\n      }).costUSD?.totalUSD\n    : undefined;\n  const totalCost = new Intl.NumberFormat(\"en-US\", {\n    style: \"currency\",\n    currency: \"USD\",\n  }).format(costUSD ?? 0);\n\n  return (\n    <div\n      className={cn(\n        \"flex w-full items-center justify-between gap-3 bg-secondary p-3 text-xs\",\n        className,\n      )}\n      {...props}\n    >\n      {children ?? (\n        <>\n          <span className=\"text-muted-foreground\">Total cost</span>\n          <span>{totalCost}</span>\n        </>\n      )}\n    </div>\n  );\n};\n\nexport type ContextInputUsageProps = ComponentProps<\"div\">;\n\nexport const ContextInputUsage = ({\n  className,\n  children,\n  ...props\n}: ContextInputUsageProps) => {\n  const { usage, modelId } = useContextValue();\n  const inputTokens = usage?.inputTokens ?? 0;\n\n  if (children) {\n    return children;\n  }\n\n  if (!inputTokens) {\n    return null;\n  }\n\n  const inputCost = modelId\n    ? getUsage({\n        modelId,\n        usage: { input: inputTokens, output: 0 },\n      })?.costUSD?.totalUSD\n    : undefined;\n  const inputCostText = new Intl.NumberFormat(\"en-US\", {\n    style: \"currency\",\n    currency: \"USD\",\n  }).format(inputCost ?? 0);\n\n  return (\n    <div\n      className={cn(\"flex items-center justify-between text-xs\", className)}\n      {...props}\n    >\n      <span className=\"text-muted-foreground\">Input</span>\n      <TokensWithCost costText={inputCostText} tokens={inputTokens} />\n    </div>\n  );\n};\n\nexport type ContextOutputUsageProps = ComponentProps<\"div\">;\n\nexport const ContextOutputUsage = ({\n  className,\n  children,\n  ...props\n}: ContextOutputUsageProps) => {\n  const { usage, modelId } = useContextValue();\n  const outputTokens = usage?.outputTokens ?? 0;\n\n  if (children) {\n    return children;\n  }\n\n  if (!outputTokens) {\n    return null;\n  }\n\n  const outputCost = modelId\n    ? getUsage({\n        modelId,\n        usage: { input: 0, output: outputTokens },\n      })?.costUSD?.totalUSD\n    : undefined;\n  const outputCostText = new Intl.NumberFormat(\"en-US\", {\n    style: \"currency\",\n    currency: \"USD\",\n  }).format(outputCost ?? 0);\n\n  return (\n    <div\n      className={cn(\"flex items-center justify-between text-xs\", className)}\n      {...props}\n    >\n      <span className=\"text-muted-foreground\">Output</span>\n      <TokensWithCost costText={outputCostText} tokens={outputTokens} />\n    </div>\n  );\n};\n\nexport type ContextReasoningUsageProps = ComponentProps<\"div\">;\n\nexport const ContextReasoningUsage = ({\n  className,\n  children,\n  ...props\n}: ContextReasoningUsageProps) => {\n  const { usage, modelId } = useContextValue();\n  const reasoningTokens = usage?.reasoningTokens ?? 0;\n\n  if (children) {\n    return children;\n  }\n\n  if (!reasoningTokens) {\n    return null;\n  }\n\n  const reasoningCost = modelId\n    ? getUsage({\n        modelId,\n        usage: { reasoningTokens },\n      })?.costUSD?.totalUSD\n    : undefined;\n  const reasoningCostText = new Intl.NumberFormat(\"en-US\", {\n    style: \"currency\",\n    currency: \"USD\",\n  }).format(reasoningCost ?? 0);\n\n  return (\n    <div\n      className={cn(\"flex items-center justify-between text-xs\", className)}\n      {...props}\n    >\n      <span className=\"text-muted-foreground\">Reasoning</span>\n      <TokensWithCost costText={reasoningCostText} tokens={reasoningTokens} />\n    </div>\n  );\n};\n\nexport type ContextCacheUsageProps = ComponentProps<\"div\">;\n\nexport const ContextCacheUsage = ({\n  className,\n  children,\n  ...props\n}: ContextCacheUsageProps) => {\n  const { usage, modelId } = useContextValue();\n  const cacheTokens = usage?.cachedInputTokens ?? 0;\n\n  if (children) {\n    return children;\n  }\n\n  if (!cacheTokens) {\n    return null;\n  }\n\n  const cacheCost = modelId\n    ? getUsage({\n        modelId,\n        usage: { cacheReads: cacheTokens, input: 0, output: 0 },\n      })?.costUSD?.totalUSD\n    : undefined;\n  const cacheCostText = new Intl.NumberFormat(\"en-US\", {\n    style: \"currency\",\n    currency: \"USD\",\n  }).format(cacheCost ?? 0);\n\n  return (\n    <div\n      className={cn(\"flex items-center justify-between text-xs\", className)}\n      {...props}\n    >\n      <span className=\"text-muted-foreground\">Cache</span>\n      <TokensWithCost costText={cacheCostText} tokens={cacheTokens} />\n    </div>\n  );\n};\n\nconst TokensWithCost = ({\n  tokens,\n  costText,\n}: {\n  tokens?: number;\n  costText?: string;\n}) => (\n  <span>\n    {tokens === undefined\n      ? \"—\"\n      : new Intl.NumberFormat(\"en-US\", {\n          notation: \"compact\",\n        }).format(tokens)}\n    {costText ? (\n      <span className=\"ml-2 text-muted-foreground\">• {costText}</span>\n    ) : null}\n  </span>\n);\n",
      "type": "registry:component",
      "target": "components/agent/context.tsx"
    },
    {
      "path": "src/registry/agentstart/model-selector.tsx",
      "content": "/* agent-frontmatter:start\nAGENT: Model Selector UI Component\nPURPOSE: Complete model selection component with API integration and state management\nUSAGE: import { ModelSelector } from \"agentstart/components\"\nEXPORTS: ModelSelector, ModelSelectorProps\nFEATURES:\n  - Fetches available models from API automatically\n  - Manages model selection state globally via store\n  - Auto-injects modelId into message sending\n  - Dialog-based UI with search and grouping\n  - Provider logo display support\nSEARCHABLE: model selector, model picker, ui component, model switcher\nagent-frontmatter:end */\n\n\"use client\";\n\nimport { CaretDownIcon, CheckIcon } from \"@phosphor-icons/react\";\nimport { useModelSelector } from \"agentstart/client\";\nimport type { ComponentProps, ReactNode } from \"react\";\nimport { useMemo, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { cn } from \"@/lib/utils\";\n\n/**\n * Provider logo component with built-in logo URL generation\n * Supports 50+ providers including OpenAI, Anthropic, Google, etc.\n */\nexport type ModelLogoProps = Omit<ComponentProps<\"img\">, \"src\" | \"alt\"> & {\n  provider: string;\n};\n\nconst ModelLogo = ({ provider, className, ...props }: ModelLogoProps) => (\n  <img\n    {...props}\n    alt={`${provider} logo`}\n    className={cn(\"size-4 shrink-0\", className)}\n    height={12}\n    src={`https://models.dev/logos/${provider}.svg`}\n    width={12}\n  />\n);\n\n/**\n * Model Selector Props\n */\nexport interface ModelSelectorProps {\n  /**\n   * Dialog title\n   */\n  title?: ReactNode;\n  /**\n   * Custom className for the dialog content\n   */\n  className?: string;\n  /**\n   * Placeholder text for search input\n   */\n  searchPlaceholder?: string;\n  /**\n   * Empty state text when no models found\n   */\n  emptyText?: string;\n  /**\n   * Whether to group models by provider\n   */\n  groupByProvider?: boolean;\n}\n\n/**\n * Complete Model Selector component with API integration\n *\n * Features:\n * - Automatically fetches available models from the API\n * - Manages selection state globally\n * - Auto-injects modelId when sending messages via useThread\n * - Searchable dialog interface with provider grouping\n *\n * @example\n * ```tsx\n * // Basic usage - uses default trigger\n * <ModelSelector />\n *\n * // Custom trigger\n * <ModelSelector\n *   trigger={<Button>Choose Model</Button>}\n *   groupByProvider={true}\n * />\n * ```\n */\nexport function ModelSelector({\n  title = \"Select Model\",\n  className,\n  searchPlaceholder = \"Search models...\",\n  emptyText = \"No models found.\",\n  groupByProvider = true,\n}: ModelSelectorProps) {\n  const {\n    models,\n    selectedModelId,\n    setSelectedModelId,\n    selectedModel,\n    isEnabled,\n  } = useModelSelector();\n\n  const [open, setOpen] = useState(false);\n\n  // Group models by provider if enabled\n  const groupedModels = useMemo(() => {\n    if (!groupByProvider) {\n      return { All: models };\n    }\n\n    return models.reduce<Record<string, typeof models>>((acc, model) => {\n      const provider = model.provider || \"Other\";\n      if (!acc[provider]) {\n        acc[provider] = [];\n      }\n      acc[provider].push(model);\n      return acc;\n    }, {});\n  }, [models, groupByProvider]);\n\n  // Don't render if models are not configured\n  if (!isEnabled) {\n    return null;\n  }\n\n  const handleSelect = (modelId: string) => {\n    setSelectedModelId(modelId);\n    setOpen(false);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={setOpen}>\n      <DialogTrigger\n        render={\n          <Button type=\"button\" variant=\"ghost\" size=\"sm\">\n            {selectedModel && <ModelLogo provider={selectedModel.provider} />}\n            <span className=\"truncate\">\n              {selectedModel ? selectedModel.name : \"Select model\"}\n            </span>\n            <CaretDownIcon className=\"ml-auto size-3.5 shrink-0 opacity-50\" />\n          </Button>\n        }\n      />\n\n      <DialogContent className={cn(\"p-0\", className)}>\n        <DialogTitle className=\"sr-only\">{title}</DialogTitle>\n        <Command className=\"**:data-[slot=command-input-wrapper]:h-auto\">\n          <CommandInput\n            className=\"h-auto py-3.5\"\n            placeholder={searchPlaceholder}\n          />\n\n          <CommandList>\n            <CommandEmpty>{emptyText}</CommandEmpty>\n\n            {Object.entries(groupedModels).map(([provider, providerModels]) => (\n              <CommandGroup\n                key={provider}\n                heading={groupByProvider ? provider : undefined}\n              >\n                {Array.isArray(providerModels) &&\n                  providerModels.map((model) => (\n                    <CommandItem\n                      key={model.id}\n                      value={`${model.provider}/${model.name}`}\n                      onSelect={() => handleSelect(model.id)}\n                      className=\"flex items-center gap-2\"\n                    >\n                      <ModelLogo provider={model.provider} />\n                      <span className=\"flex-1 truncate text-left\">\n                        {model.name}\n                      </span>\n                      {selectedModelId === model.id && (\n                        <CheckIcon className=\"ml-auto size-4\" weight=\"bold\" />\n                      )}\n                    </CommandItem>\n                  ))}\n              </CommandGroup>\n            ))}\n          </CommandList>\n        </Command>\n      </DialogContent>\n    </Dialog>\n  );\n}\n",
      "type": "registry:component",
      "target": "components/agent/model-selector.tsx"
    },
    {
      "path": "src/registry/agentstart/queue.tsx",
      "content": "/* agent-frontmatter:start\nAGENT: Prompt queue components\nPURPOSE: Render queued agent tasks, files, and todos with collapsible sections\nUSAGE: import { Queue, QueueItem, QueueSection } from \\\"@/components/agent/queue\\\"\nEXPORTS: Queue, QueueItem, QueueItemIndicator, QueueItemContent, QueueItemDescription, QueueItemActions, QueueItemAction, QueueItemAttachment, QueueItemImage, QueueItemFile, QueueList, QueueSection, QueueSectionTrigger, QueueSectionLabel, QueueSectionContent\nFEATURES:\n  - Collapsible queue sections with counts\n  - Attachment previews for files and images\nSEARCHABLE: queue ui, task list, attachments queue, agent queue\nagent-frontmatter:end */\n\n\"use client\";\n\nimport { CaretDownIcon, FileIcon } from \"@phosphor-icons/react\";\nimport type { ComponentProps } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { cn } from \"@/lib/utils\";\n\nexport type QueueMessagePart = {\n  type: string;\n  text?: string;\n  url?: string;\n  filename?: string;\n  mediaType?: string;\n};\n\nexport type QueueMessage = {\n  id: string;\n  parts: QueueMessagePart[];\n};\n\nexport type QueueTodo = {\n  id: string;\n  title: string;\n  description?: string;\n  status?: \"pending\" | \"completed\";\n};\n\nexport type QueueItemProps = ComponentProps<\"li\">;\n\nexport const QueueItem = ({ className, ...props }: QueueItemProps) => (\n  <li\n    className={cn(\n      \"group flex flex-col gap-1 rounded-md px-3 py-1 text-sm transition-colors hover:bg-muted\",\n      className,\n    )}\n    {...props}\n  />\n);\n\nexport type QueueItemIndicatorProps = ComponentProps<\"span\"> & {\n  completed?: boolean;\n};\n\nexport const QueueItemIndicator = ({\n  completed = false,\n  className,\n  ...props\n}: QueueItemIndicatorProps) => (\n  <span\n    className={cn(\n      \"mt-0.5 inline-block size-2.5 rounded-full border\",\n      completed\n        ? \"border-muted-foreground/20 bg-muted-foreground/10\"\n        : \"border-muted-foreground/50\",\n      className,\n    )}\n    {...props}\n  />\n);\n\nexport type QueueItemContentProps = ComponentProps<\"span\"> & {\n  completed?: boolean;\n};\n\nexport const QueueItemContent = ({\n  completed = false,\n  className,\n  ...props\n}: QueueItemContentProps) => (\n  <span\n    className={cn(\n      \"wrap-break-word line-clamp-1 grow\",\n      completed\n        ? \"text-muted-foreground/50 line-through\"\n        : \"text-muted-foreground\",\n      className,\n    )}\n    {...props}\n  />\n);\n\nexport type QueueItemDescriptionProps = ComponentProps<\"div\"> & {\n  completed?: boolean;\n};\n\nexport const QueueItemDescription = ({\n  completed = false,\n  className,\n  ...props\n}: QueueItemDescriptionProps) => (\n  <div\n    className={cn(\n      \"ml-6 text-xs\",\n      completed\n        ? \"text-muted-foreground/40 line-through\"\n        : \"text-muted-foreground\",\n      className,\n    )}\n    {...props}\n  />\n);\n\nexport type QueueItemActionsProps = ComponentProps<\"div\">;\n\nexport const QueueItemActions = ({\n  className,\n  ...props\n}: QueueItemActionsProps) => (\n  <div className={cn(\"flex gap-1\", className)} {...props} />\n);\n\nexport type QueueItemActionProps = Omit<\n  ComponentProps<typeof Button>,\n  \"variant\" | \"size\"\n>;\n\nexport const QueueItemAction = ({\n  className,\n  ...props\n}: QueueItemActionProps) => (\n  <Button\n    className={cn(\n      \"size-auto rounded p-1 text-muted-foreground opacity-0 transition-opacity hover:bg-muted-foreground/10 hover:text-foreground group-hover:opacity-100\",\n      className,\n    )}\n    size=\"icon\"\n    type=\"button\"\n    variant=\"ghost\"\n    {...props}\n  />\n);\n\nexport type QueueItemAttachmentProps = ComponentProps<\"div\">;\n\nexport const QueueItemAttachment = ({\n  className,\n  ...props\n}: QueueItemAttachmentProps) => (\n  <div className={cn(\"mt-1 flex flex-wrap gap-2\", className)} {...props} />\n);\n\nexport type QueueItemImageProps = ComponentProps<\"img\">;\n\nexport const QueueItemImage = ({\n  className,\n  ...props\n}: QueueItemImageProps) => (\n  <img\n    alt=\"\"\n    className={cn(\"h-8 w-8 rounded border object-cover\", className)}\n    height={32}\n    width={32}\n    {...props}\n  />\n);\n\nexport type QueueItemFileProps = ComponentProps<\"span\">;\n\nexport const QueueItemFile = ({\n  children,\n  className,\n  ...props\n}: QueueItemFileProps) => (\n  <span\n    className={cn(\n      \"flex items-center gap-1 rounded border bg-muted px-2 py-1 text-xs\",\n      className,\n    )}\n    {...props}\n  >\n    <FileIcon size={12} />\n    <span className=\"max-w-[100px] truncate\">{children}</span>\n  </span>\n);\n\nexport type QueueListProps = ComponentProps<typeof ScrollArea>;\n\nexport const QueueList = ({\n  children,\n  className,\n  ...props\n}: QueueListProps) => (\n  <ScrollArea className={cn(\"-mb-1 mt-2\", className)} {...props}>\n    <div className=\"max-h-40 pr-4\">\n      <ul>{children}</ul>\n    </div>\n  </ScrollArea>\n);\n\n// QueueSection - collapsible section container\nexport type QueueSectionProps = ComponentProps<typeof Collapsible>;\n\nexport const QueueSection = ({\n  className,\n  defaultOpen = true,\n  ...props\n}: QueueSectionProps) => (\n  <Collapsible className={cn(className)} defaultOpen={defaultOpen} {...props} />\n);\n\n// QueueSectionTrigger - section header/trigger\nexport type QueueSectionTriggerProps = ComponentProps<\"button\">;\n\nexport const QueueSectionTrigger = ({\n  children,\n  className,\n  ...props\n}: QueueSectionTriggerProps) => (\n  <CollapsibleTrigger\n    render={\n      <button\n        className={cn(\n          \"group flex w-full items-center justify-between rounded-md bg-muted/40 px-3 py-2 text-left font-medium text-muted-foreground text-sm transition-colors hover:bg-muted\",\n          className,\n        )}\n        type=\"button\"\n        {...props}\n      />\n    }\n  >\n    {children}\n  </CollapsibleTrigger>\n);\n\n// QueueSectionLabel - label content with icon and count\nexport type QueueSectionLabelProps = ComponentProps<\"span\"> & {\n  count?: number;\n  label: string;\n  icon?: React.ReactNode;\n};\n\nexport const QueueSectionLabel = ({\n  count,\n  label,\n  icon,\n  className,\n  ...props\n}: QueueSectionLabelProps) => (\n  <span className={cn(\"flex items-center gap-2\", className)} {...props}>\n    <CaretDownIcon className=\"group-data-panel-open:-rotate-90 size-3 transition-transform\" />\n    {icon}\n    <span>\n      {count} {label}\n    </span>\n  </span>\n);\n\n// QueueSectionContent - collapsible content area\nexport type QueueSectionContentProps = ComponentProps<\n  typeof CollapsibleContent\n>;\n\nexport const QueueSectionContent = ({\n  className,\n  ...props\n}: QueueSectionContentProps) => (\n  <CollapsibleContent className={cn(className)} {...props} />\n);\n\nexport type QueueProps = ComponentProps<\"div\">;\n\nexport const Queue = ({ className, ...props }: QueueProps) => (\n  <div\n    className={cn(\n      \"flex flex-col gap-2 rounded-xl border border-border bg-background px-3 pt-2 pb-2 shadow-xs\",\n      className,\n    )}\n    {...props}\n  />\n);\n",
      "type": "registry:component",
      "target": "components/agent/queue.tsx"
    }
  ]
}