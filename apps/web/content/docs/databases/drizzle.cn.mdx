---
title: Drizzle ORM 适配器
description: 将 AgentStart 与 Drizzle ORM 集成
---

# Drizzle ORM 适配器

Drizzle ORM 是一个强大而灵活的 Node.js 和 TypeScript ORM。它提供完全类型安全的简洁直观的 API，支持 PostgreSQL、MySQL 和 SQLite。

## 安装

```bash
npm install drizzle-orm
```

安装您的数据库驱动：

<Tabs items={["PostgreSQL", "MySQL", "SQLite"]}>
  <Tab value="PostgreSQL">
    ```bash
    npm install @neondatabase/serverless
    # 或
    npm install pg
    ```
  </Tab>
  
  <Tab value="MySQL">
    ```bash
    npm install mysql2
    ```
  </Tab>
  
  <Tab value="SQLite">
    ```bash
    npm install better-sqlite3
    ```
  </Tab>
</Tabs>

## 使用示例

<Steps>

<Step>

### 定义架构

使用 Drizzle 创建数据库架构：

```ts title="db/schema.ts"
import { pgTable, text, timestamp, jsonb } from "drizzle-orm/pg-core";

export const threadsTable = pgTable("threads", {
  id: text("id").primaryKey(),
  title: text("title"),
  userId: text("user_id"),
  createdAt: timestamp("created_at").defaultNow(),
  metadata: jsonb("metadata"),
});

export const messagesTable = pgTable("messages", {
  id: text("id").primaryKey(),
  threadId: text("thread_id").references(() => threadsTable.id),
  role: text("role"),
  content: text("content"),
  createdAt: timestamp("created_at").defaultNow(),
  metadata: jsonb("metadata"),
});
```

</Step>

<Step>

### 初始化 Drizzle

```ts title="db/index.ts"
import { drizzle } from "drizzle-orm/neon-http";
import { neon } from "@neondatabase/serverless";

const sql = neon(process.env.DATABASE_URL!);
export const db = drizzle(sql);
```

</Step>

<Step>

### 与 AgentStart 一起使用

```ts title="lib/agent.ts"
import { agentStart } from "agentstart";
import { drizzleAdapter } from "agentstart/db";
import { db } from "@/db";
import * as schema from "@/db/schema";

export const start = agentStart({
  agent,
  memory: drizzleAdapter(db, {
    provider: "pg", // 或 "mysql" 或 "sqlite"
    schema: {
      thread: schema.threadsTable,
      message: schema.messagesTable,
    },
  }),
});
```

</Step>

</Steps>

## 架构生成和迁移

AgentStart CLI 可以生成 Drizzle 架构：

```bash title="架构生成"
npx @agentstart/cli generate
```

然后使用 Drizzle Kit 应用迁移：

```bash title="架构迁移"
npx drizzle-kit generate
npx drizzle-kit push
```

## 数据库提供商

### PostgreSQL

```ts
import { drizzle } from "drizzle-orm/neon-http";
import { neon } from "@neondatabase/serverless";

const sql = neon(process.env.DATABASE_URL!);
const db = drizzle(sql);
```

### MySQL

```ts
import { drizzle } from "drizzle-orm/mysql2";
import mysql from "mysql2/promise";

const pool = mysql.createPool(process.env.DATABASE_URL!);
const db = drizzle(pool);
```

### SQLite

```ts
import { drizzle } from "drizzle-orm/better-sqlite3";
import Database from "better-sqlite3";

const sqlite = new Database("agentstart.db");
const db = drizzle(sqlite);
```

## 自定义表名

如果您的架构使用不同的表名（例如复数形式）：

```ts
import { drizzleAdapter } from "agentstart/db";

export const start = agentStart({
  agent,
  memory: drizzleAdapter(db, {
    provider: "pg",
    schema: {
      thread: threadsTable,  // 映射到 "threads" 表
      message: messagesTable, // 映射到 "messages" 表
    },
  }),
});
```

## 类型安全

Drizzle 提供完全的类型安全：

```ts
// 类型安全查询
const threads = await db.select().from(threadsTable);
//    ^? Thread[]

// 类型安全插入
await db.insert(messagesTable).values({
  id: "msg-1",
  threadId: "thread-1",
  role: "user",
  content: "你好",
});
```

## Drizzle Studio

使用 Drizzle Studio 可视化和编辑您的数据：

```bash
npx drizzle-kit studio
```

## 下一步

<Cards>
  <Card title="PostgreSQL" href="/docs/databases/postgresql" />
  <Card title="MySQL" href="/docs/databases/mysql" />
  <Card title="Prisma 适配器" href="/docs/databases/prisma" />
</Cards>
