---
title: MongoDB 适配器
description: 将 AgentStart 与 MongoDB 集成
---

# MongoDB 适配器

MongoDB 是一个流行的 NoSQL 文档数据库。AgentStart 通过原生适配器提供对 MongoDB 的一流支持。

## 安装

```bash
npm install mongodb
```

## 使用示例

<Steps>

<Step>

### 初始化 MongoDB 客户端

```ts title="db/index.ts"
import { MongoClient } from "mongodb";

const client = new MongoClient(process.env.DATABASE_URL!);

// 连接到 MongoDB
await client.connect();

export const db = client.db("agentstart");
```

</Step>

<Step>

### 与 AgentStart 一起使用

```ts title="lib/agent.ts"
import { agentStart } from "agentstart";
import { mongodbAdapter } from "agentstart/db";
import { db } from "@/db";

export const start = agentStart({
  agent,
  memory: mongodbAdapter(db),
});
```

</Step>

</Steps>

## 连接字符串

```bash
# 本地 MongoDB
DATABASE_URL="mongodb://localhost:27017"

# MongoDB Atlas
DATABASE_URL="mongodb+srv://username:password@cluster.mongodb.net/agentstart"

# 带认证的 MongoDB
DATABASE_URL="mongodb://username:password@localhost:27017/agentstart?authSource=admin"
```

## 集合

MongoDB 适配器创建这些集合：

### Threads 集合

```json
{
  "_id": "thread-id",
  "title": "我的线程",
  "userId": "user-123",
  "createdAt": ISODate("2024-01-01T00:00:00Z"),
  "metadata": {}
}
```

### Messages 集合

```json
{
  "_id": "message-id",
  "threadId": "thread-id",
  "role": "user",
  "content": "你好",
  "createdAt": ISODate("2024-01-01T00:00:00Z"),
  "metadata": {}
}
```

## 索引

适配器自动创建索引以获得最佳性能：

```ts
// 由适配器自动创建
db.collection("messages").createIndex({ threadId: 1 });
db.collection("threads").createIndex({ userId: 1 });
db.collection("threads").createIndex({ createdAt: -1 });
```

## 连接选项

配置连接池和超时：

```ts
const client = new MongoClient(process.env.DATABASE_URL!, {
  maxPoolSize: 10,
  minPoolSize: 2,
  connectTimeoutMS: 10000,
  socketTimeoutMS: 45000,
});
```

## 类型安全

为您的文档定义类型：

```ts
interface Thread {
  _id: string;
  title?: string;
  userId?: string;
  createdAt: Date;
  metadata?: Record<string, unknown>;
}

interface Message {
  _id: string;
  threadId: string;
  role: string;
  content: string;
  createdAt: Date;
  metadata?: Record<string, unknown>;
}
```

## MongoDB Atlas

对于 MongoDB Atlas（推荐用于生产）：

1. 在 [mongodb.com/cloud/atlas](https://www.mongodb.com/cloud/atlas) 创建免费集群
2. 从 Atlas 仪表板获取连接字符串
3. 将其添加到您的 `.env` 文件

```bash
DATABASE_URL="mongodb+srv://username:password@cluster.mongodb.net/agentstart?retryWrites=true&w=majority"
```

## 事务

MongoDB 适配器支持事务以确保数据一致性：

```ts
const session = client.startSession();

try {
  await session.withTransaction(async () => {
    // 这里的操作是原子的
    await db.collection("threads").insertOne({ ... });
    await db.collection("messages").insertOne({ ... });
  });
} finally {
  await session.endSession();
}
```

## 最佳实践

1. **使用连接池** - 重用客户端连接
2. **启用压缩** - 减少网络流量
3. **创建索引** - 优化查询性能
4. **监控查询** - 使用 MongoDB Atlas 监控
5. **定期备份** - 设置自动备份

## 下一步

<Cards>
  <Card title="PostgreSQL" href="/docs/databases/postgresql" />
  <Card title="Drizzle 适配器" href="/docs/databases/drizzle" />
  <Card title="Prisma 适配器" href="/docs/databases/prisma" />
</Cards>
