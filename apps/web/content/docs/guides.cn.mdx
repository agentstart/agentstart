---
title: 指南
description: 常见用例的分步指南
---

# 指南

帮助你使用 AgentStart 构建的实用指南。

## 构建你的第一个 Agent

从头开始创建一个完整的智能体应用。

<Steps>

<Step>

### 创建 Next.js 项目

```bash
npx create-next-app@latest my-agent-app
cd my-agent-app
```

</Step>

<Step>

### 安装 AgentStart

```bash
npm install agentstart @openrouter/ai-sdk-provider drizzle-orm @neondatabase/serverless
```

</Step>

<Step>

### 设置数据库架构

创建 `db/schema/agent.ts`：

```ts
import { pgTable, text, timestamp, jsonb } from "drizzle-orm/pg-core";

export const threadsTable = pgTable("threads", {
  id: text("id").primaryKey(),
  title: text("title"),
  userId: text("user_id"),
  createdAt: timestamp("created_at").defaultNow(),
  metadata: jsonb("metadata"),
});

export const messagesTable = pgTable("messages", {
  id: text("id").primaryKey(),
  threadId: text("thread_id").references(() => threadsTable.id),
  role: text("role"),
  content: text("content"),
  createdAt: timestamp("created_at").defaultNow(),
  metadata: jsonb("metadata"),
});
```

</Step>

<Step>

### 配置 Agent

创建 `lib/agent.ts`：

```ts
import { createOpenRouter } from "@openrouter/ai-sdk-provider";
import { agentStart } from "agentstart";
import { Agent, innerTools, osTools } from "agentstart/agent";
import { drizzleAdapter } from "agentstart/db";
import { db } from "@/db";
import * as schema from "@/db/schema";

const openrouter = createOpenRouter({
  apiKey: process.env.MODEL_PROVIDER_API_KEY!,
});

const agent = new Agent({
  model: openrouter("x-ai/grok-4-fast"),
  instructions: "你是一个乐于助人的编程助手。",
  tools: {
    ...innerTools,
    ...osTools,
  },
});

export const start = agentStart({
  agent,
  memory: drizzleAdapter(db, {
    provider: "pg",
    schema: {
      thread: schema.threadsTable,
      message: schema.messagesTable,
    },
  }),
  appName: "my-agent-app",
});
```

</Step>

<Step>

### 创建 API 路由

创建 `app/api/agent/[...all]/route.ts`：

```ts
import { toNextJsHandler } from "agentstart/integration";
import { start } from "@/lib/agent";

export const { POST, GET } = toNextJsHandler(start.handler);
```

</Step>

<Step>

### 创建客户端

创建 `lib/agent-client.ts`：

```ts
import { createAgentClient } from "agentstart/client";

export const { client, useThread } = createAgentClient();
export { useAgentStore } from "agentstart/client";
```

</Step>

<Step>

### 创建 UI

创建 `app/thread/[threadId]/page.tsx`：

```tsx
"use client";

import { Conversation } from "@/components/agent/conversation";
import { PromptInput } from "@/components/agent/prompt-input";
import { useAgentStore, useThread } from "@/lib/agent-client";
import { useParams } from "next/navigation";

export default function ThreadPage() {
  const { threadId } = useParams<{ threadId: string }>();
  useThread(threadId);
  
  const sendMessage = useAgentStore((state) => state.sendMessage, threadId);

  return (
    <div className="flex h-screen flex-col">
      <Conversation threadId={threadId} />
      <PromptInput
        threadId={threadId}
        onMessageSubmit={async (message) => {
          await sendMessage({ text: message.text ?? "" });
        }}
      />
    </div>
  );
}
```

</Step>

<Step>

### 运行应用

```bash
npm run dev
```

访问 `http://localhost:3000` 查看你的智能体！

</Step>

</Steps>

## 添加认证

使用 `getUserId` 保护你的智能体路由。

```ts
import { agentStart } from "agentstart";

export const start = agentStart({
  agent,
  memory,
  getUserId: async (headers) => {
    // 从 auth header 提取用户 ID
    const token = headers.get("authorization");
    if (!token) throw new Error("未授权");
    const user = await verifyToken(token);
    return user.id;
  },
});
```

## 自定义工具

创建自定义工具来扩展你的智能体功能。

```ts
import { z } from "zod";

const weatherTool = {
  description: "获取当前天气",
  parameters: z.object({
    location: z.string().describe("城市名称"),
    units: z.enum(["celsius", "fahrenheit"]).default("celsius"),
  }),
  execute: async ({ location, units }) => {
    // 你的天气 API 逻辑
    return { temperature: 72, condition: "晴朗", units };
  },
};

const agent = new Agent({
  model,
  instructions: "你是一个天气助手。",
  tools: {
    ...innerTools,
    weather: weatherTool,
  },
});
```

## 中间件

添加自定义中间件进行日志记录、分析等。

```ts
import { os, onStart, onSuccess, onError } from "@orpc/server";

const loggingMiddleware = os.middleware(async ({ next }) => {
  console.log("请求开始");
  const result = await next();
  console.log("请求完成");
  return result;
});

export const start = agentStart({
  agent,
  memory,
  middleware: [
    loggingMiddleware,
    onStart(() => console.log("处理器启动")),
    onSuccess(() => console.log("处理器成功")),
    onError((error) => console.error("处理器错误:", error)),
  ],
});
```

## 部署

### Vercel

```bash
vercel
```

在 Vercel 仪表板中添加环境变量：
- `MODEL_PROVIDER_API_KEY`
- `DATABASE_URL`

### Docker

```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["npm", "start"]
```

```bash
docker build -t my-agent .
docker run -p 3000:3000 --env-file .env my-agent
```

## 最佳实践

### 1. 错误处理

```tsx
try {
  await sendMessage({ text: input });
} catch (error) {
  console.error("发送消息失败:", error);
  // 显示用户友好的错误消息
}
```

### 2. 加载状态

```tsx
const isLoading = useAgentStore((state) => state.isLoading, threadId);

{isLoading && <Spinner />}
```

### 3. 优化性能

```tsx
// 使用 React.memo 进行消息组件
const Message = React.memo(({ message }) => {
  return <div>{message.content}</div>;
});
```

### 4. 类型安全

```tsx
import type { Thread, Message } from "agentstart";

const thread: Thread = await start.api.thread.create({ title: "新线程" });
```

## 下一步

<Cards>
  <Card title="API 参考" href="/docs/reference/api" />
  <Card title="组件" href="/docs/components/overview" />
  <Card title="数据库" href="/docs/concepts/database" />
</Cards>
